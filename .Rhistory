rm(list=ls())
### Loading libraries
library(raster)
library(rgdal)
library(rgeos)
library(ggplot2)
library(sf)
library(rmarkdown)
setwd('/home/james/github/uk_cmaq_air_quality_index')
latlong                   <- "+init=epsg:4326"
ukgrid                    <- "+init=epsg:27700"
google                    <- "+init=epsg:3857"
concentrations_url    <- 'https://files.datapress.com/london/dataset/london-atmospheric-emissions-inventory-2013/2017-01-26T18:50:00/4.1.%20Concentrations%20LAEI%202013%20Update.zip'
temp = tempfile()
download.file(concentrations_url, temp, method = 'curl')
unzip(temp, exdir = ".")
no2_2013                      <- raster('4.1. Concentrations LAEI 2013 Update/2013/ASCII/PostLAEI2013_2013_NO2.asc')
proj4string(no2_2013)         <- CRS(ukgrid)
pm25_2013                      <- raster('4.1. Concentrations LAEI 2013 Update/2013/ASCII/PostLAEI2013_2013_PM25.asc')
proj4string(pm25_2013)         <- CRS(ukgrid)
london                        <- st_read('https://raw.githubusercontent.com/KCL-ERG/useful_geography/master/london_boroughs.geojson')
london                        <- as(london, 'Spatial')
london                        <- spTransform(london, ukgrid)
westminster                   <- london[london$NAME == 'Westminster',]
rm(london)
pm25_westminster_laei          <- crop(pm25_2013, westminster)
pm25_westminster_laei         <- mask(pm25_westminster_laei, westminster)
no2_westminster_laei          <- crop(no2_2013,  westminster)
no2_westminster_laei          <- mask(no2_westminster_laei,  westminster)
writeRaster(no2_westminster_laei,   filename="gis_results/no2_westminster_laei", overwrite=TRUE, format='EHdr')
#no2_colours
source('https://raw.githubusercontent.com/KCL-ERG/colour_schemes/master/no2_laei2013_colours_breaks.R')
source('https://raw.githubusercontent.com/KCL-ERG/colour_schemes/master/pm25_laei2013_colours_breaks.R')
no2_laei2013_breaks  <- as.numeric(c(round(cellStats(no2_westminster_laei, stat=min)-1,4),format(round(quantile(no2_westminster_laei, seq(0,1,length.out = 15)),4), scientific=F), round(cellStats(no2_westminster_laei, stat=max)+1,4))) #17
no2_laei2013_labels  <- c("", paste(no2_laei2013_breaks[1:length(no2_laei2013_breaks)-1], "-",
no2_laei2013_breaks[2:length(no2_laei2013_breaks)])) #17 (same as breaks)
png('png_outputs/no2_westminster_laei.png', width = 10, height = 8, units = 'in', res = 300)
levelplot(no2_westminster_laei,
maxpixels = no2_westminster_laei@ncols/2 * no2_westminster_laei@nrows/2,
margin = FALSE,
colorkey = list(
at = seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = length(no2_laei2013_breaks)),
space = 'right',
labels = list(at=seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = length(no2_laei2013_breaks)),
labels = paste(" \n \n ",no2_laei2013_labels),
font = 1,
cex = 1.5)
),
par.settings = list(
axis.line =list( col = 'transparent')
),
scales = list(draw = FALSE),
col.regions = no2_laei2013_colours,
at = no2_laei2013_breaks)
dev.off()
library(rasterVis)
no2_laei2013_breaks  <- as.numeric(c(round(cellStats(no2_westminster_laei, stat=min)-1,4),format(round(quantile(no2_westminster_laei, seq(0,1,length.out = 15)),4), scientific=F), round(cellStats(no2_westminster_laei, stat=max)+1,4))) #17
no2_laei2013_labels  <- c("", paste(no2_laei2013_breaks[1:length(no2_laei2013_breaks)-1], "-",
no2_laei2013_breaks[2:length(no2_laei2013_breaks)])) #17 (same as breaks)
png('png_outputs/no2_westminster_laei.png', width = 10, height = 8, units = 'in', res = 300)
levelplot(no2_westminster_laei,
maxpixels = no2_westminster_laei@ncols/2 * no2_westminster_laei@nrows/2,
margin = FALSE,
colorkey = list(
at = seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = length(no2_laei2013_breaks)),
space = 'right',
labels = list(at=seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = length(no2_laei2013_breaks)),
labels = paste(" \n \n ",no2_laei2013_labels),
font = 1,
cex = 1.5)
),
par.settings = list(
axis.line =list( col = 'transparent')
),
scales = list(draw = FALSE),
col.regions = no2_laei2013_colours,
at = no2_laei2013_breaks)
dev.off()
