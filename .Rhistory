library(rvest)
rm(list=ls())
### Loading any missing libraries
library(rvest)
library(stringr)
library(raster)
library(rgdal)
library(rgeos)
library(ggplot2)
library(sf)
library(rmarkdown)
system('scp james@10.0.4.225/mnt/modelling2/UKmaps20m/* .')
system('sshpass -p "brianclough" scp james@10.0.4.225/mnt/modelling2/UKmaps20m/* .'')
system('sshpass -p "brianclough" scp james@10.0.4.225/mnt/modelling2/UKmaps20m/* .')
system('sshpass -f "../cluster2password.txt" scp james@10.0.4.225/mnt/modelling2/UKmaps20m/* .')
system('sshpass -f "../cluster2password.txt" scp james@10.0.4.225:/mnt/modelling2/UKmaps20m/* .')
eng_scot_wales <- st_read('https://raw.githubusercontent.com/JimShady/useful_geography/master/eng_scot_wales.geojson')
## read in the raster files
pm25 <- raster('Annual_CMAQUrban_NO2_2012.grd')
pm25
crs(pm25)
no2 <- raster('Annual_CMAQUrban_PM25_2012.grd')
cellStats(pm25, stat=mean
)
plot(eng_scot_wales)
plot(st_geometry(eng_scot_wales))
eng_scot_wales
extent(pm25)
eng_scot_wales <- st_transform(eng_scot_wales, 27700)
eng_scot_wales <- st_transform(eng_scot_wales, 4326)
extent(eng_scot_wales)
eng_scot_wales <- st_transform(eng_scot_wales, 27700)
extent(eng_scot_wales)
plot(pm25)
plot(st_geometry(eng_scot_wales), add=T)
crs(pm25)
eng_scot_wales <- st_transform(eng_scot_wales, crs(pm25))
proj4string(pm25)
eng_scot_wales <- st_transform(eng_scot_wales, CRS(proj4string(pm25))
)
eng_scot_wales <- st_transform(eng_scot_wales, proj4string(pm25))
plot(st_geometry(eng_scot_wales), add=T)
head(eng_scot_wales)
eng_scot_wales$mean_pm25  <- extract(pm25, eng_scot_wales)
extract(pm25. eng_scot_wales[1:10,], fun=mean
extract(pm25. eng_scot_wales[1:10,], fun=mean)
extract(pm25, eng_scot_wales[1:10,], fun=mean)
eng_scot_wales[1:10,]
## Extract pm2.5 and no2 concentrations by polygon
eng_scot_wales$mean_pm25  <- extract(pm25, eng_scot_wales, fun=mean, method='simple')
rm(list=ls())
### Loading libraries
library(raster)
library(rgdal)
library(rgeos)
library(ggplot2)
library(sf)
library(rmarkdown)
## Copy maps over from cluster2
system('sshpass -f "../cluster2password.txt" scp james@10.0.4.225:/mnt/modelling2/UKmaps20m/* .')
latlong                   <- "+init=epsg:4326"
ukgrid                    <- "+init=epsg:27700"
google                    <- "+init=epsg:3857"
## read in the raster files and UK shapefile
pm25                      <- raster('Annual_CMAQUrban_NO2_2012.grd')
no2                       <- raster('Annual_CMAQUrban_PM25_2012.grd')
eng_scot_wales            <- st_read('https://raw.githubusercontent.com/JimShady/useful_geography/master/eng_scot_wales.geojson')
## Convert to same crs as the raster files. Just use pm25 one, could have used no2 instead.
eng_scot_wales            <- st_transform(eng_scot_wales, proj4string(pm25))
## Extract pm2.5 and no2 concentrations by polygon
eng_scot_wales$mean_pm25  <- extract(pm25, eng_scot_wales, fun=mean, method='simple')
eng_scot_wales$mean_no2   <- extract(no2,  eng_scot_wales, fun=mean, method='simple')
head(eng_scot_wales)
mean(eng_scot_wales$mean_pm25)
## Get countrywide means
country_mean_pm25         <- mean(eng_scot_wales$mean_pm25)
country_mean_no2          <- mean(eng_scot_wales$mean_no2)
test <- no2
test                       <- addLayer(test, test/country_mean_no2)
test
test <- stack(test, test/country_mean_no2)
test
test/2
test
plot(test)
test <- stack(test, test/country_mean_no2)
test
head(eng_scot_wales)
names(eng_scot_wales)
names(eng_scot_wales)[61]
names(eng_scot_wales)[61] <- 'mean_no2_'
names(eng_scot_wales)[62] <- 'mean_pm25'
names(eng_scot_wales)[61] <- 'mean_no2'
names(eng_scot_wales)
## Get countrywide means
country_mean_pm25         <- mean(eng_scot_wales$mean_pm25)
country_mean_no2          <- mean(eng_scot_wales$mean_no2)
## Index value (Add new layer to the raster)
pm25                      <- addLayer(pm25, pm25/country_mean_pm25)
pm25
no2
actual_no2 <- pm25
actual_pm25 <- no2
pm25 <- actual_pm25
no2 <- actual_no2
rm(actual_no2, actual_pm25)
rm(test)
## Get countrywide means
country_mean_pm25         <- mean(eng_scot_wales$mean_pm25)
country_mean_no2          <- mean(eng_scot_wales$mean_no2)
test <- raster('Annual_CMAQUrban_PM25_2012.grd')
cellStas(test, stat=mean)
cellStats(test, stat=mean)
## Get countrywide means
country_mean_pm25         <- mean(eng_scot_wales$mean_pm25)
country_mean_no2          <- mean(eng_scot_wales$mean_no2)
rm(test)
ggplot(eng_scot_wales) +
geom_sf(aes(fill = mean_pm25))
ggplot(eng_scot_wales) +
geom_sf(aes(fill = mean_no2))
head(eng_scot_wales)
ggplot(eng_scot_wales) +
geom_sf(aes(fill = mean_no2))
pm25
## Index value (Add new layer to the raster, turn into stack)
pm25                      <- stack(pm25, pm25/country_mean_pm25)
no2                       <- stack(no2, no2/country_mean_no2)
st_write(eng_scot_wales, 'eng_scot_wales_conc_averages.geojson')
pm25
names(pm25)
names(pm25)               <- c('pm25', 'relative_pm25')
names(no2)                <- c('no2', 'relative_no2')
uk_air_quality_index      <- stack(pm25, no2)
uk_air_quality_index
raster[3]
uk_air_quality_index[[3]]
uk_air_quality_index[[c(2,4)]]
uk_air_quality_index      <- uk_air_quality_index[[c(2,4)]]
eng_scot_wales[eng_scot_wales$name == 'Southwarkk',]
eng_scot_wales[eng_scot_wales$name == 'Southwark',]
eng_scot_wales[eng_scot_wales$name == 'Birmingham',]
eng_scot_wales[eng_scot_wales$name == 'Leicester',]
plot(st_geography(eng_scot_wales[eng_scot_wales$name == 'Leicester',]))
plot(st_geometry(eng_scot_wales[eng_scot_wales$name == 'Leicester',]))
plot(eng_scot_wales[138,])
plot(st_geometry(ng_scot_wales[138:145,]))
plot(st_geometry(eng_scot_wales[138:145,]))
## Crop to areas of concern
eng_scot_wales[eng_scot_wales$$name %in% c('Leicester', 'Southwark'),]
## Crop to areas of concern
eng_scot_wales[eng_scot_wales$name %in% c('Leicester', 'Southwark'),]
## Crop to areas of concern
uk_air_quality_index      <- crop(uk_air_quality_index, eng_scot_wales[eng_scot_wales$name %in% c('Leicester', 'Southwark'),])
## Crop to areas of concern
example_areas             <- as(eng_scot_wales[eng_scot_wales$name %in% c('Leicester', 'Southwark'),], 'Spatial')
uk_air_quality_index      <- crop(uk_air_quality_index, example_areas)
uk_air_quality_index      <- mask(uk_air_quality_index, example_areas)
plot(uk_air_quality_index)
writeRaster(uk_air_quality_index, filename="uk_air_quality_index.asc", overwrite=TRUE)
writeRaster(uk_air_quality_index, filename="uk_air_quality_index.gri", overwrite=TRUE)
